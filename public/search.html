<!DOCTYPE html>
<html lang='zh-CN'>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='/static/img/avatar.jpg' rel='shortcut icon'>
  <title>blog search page</title>
  <link href='/static/css/blog.css' rel='stylesheet'>
  <meta name="generator" content="ebtp">
</head>
<body class='rich_media rich_media_inner'>
  <div class='page-content footer-push section' id='container'>
    <div id="postsContainer">loading...</div>
    <div class='rich_media_tool navigator'>
      <div class='media_tool_meta tips_global meta_primary'>导航：</div>
      <a id="nextCursor" href="#">←较旧的博文</a>
      <a id="preCursor" href="#">较新的博文→</a>
      <a class='tips_global meta_extra' href='#'>↑回到页顶</a>
    </div>
    <div class='footer-pad'></div>
  </div>
  <div class='qr_code_pc_outer'>
    <div class='qr_code_pc_inner'>
      <div class='qr_code_pc'>
      <div id="actoravatar" class='qr_code_pc_img'></div>
      <a id="actorDisplayName" href="/about"></a>
      </div>
    </div>
  </div>
  <footer>Power by atproto & ebtp</footer>
  <script type="module">
  import * as utils from '/static/js/common.js'
  const response = await fetch('/config')
  const config = await response.json()
  let url = new URL(location.href)

  switch(url.pathname) {
    case '/':
      renderIndexPage(url)
      break
    case '/search':
      search(url)
      break
    default:
      throw Error(`path ${url.pathname} not support`)
  }
  await utils.initBackgroundPic();

  function search(url) {
    if (url.searchParams.get('q')) {
      renderKeywordSearch(url)
    } else if (url.searchParams.get('tag')) {
      renderTagSearch(url)
    }
  }

  async function renderTagSearch(url) {
    document.querySelector('title').innerText = utils.convertStringToTemplate(document.querySelector('title').innerText, {title: `Tag:${url.searchParams.get('tag')}`})
    const q = `#${url.searchParams.get('tag')} from:${config.handle}`
    let search_url = new URL(`https://${url.host}/searchBlogs?q=${encodeURIComponent(q)}&limit=100&sort=latest&domain=${config.gate_host}`)
    await renderSearch(search_url)
  }

  async function renderKeywordSearch(url) {
    document.querySelector('title').innerText = utils.convertStringToTemplate(document.querySelector('title').innerText, {title: `Keyword:${url.searchParams.get('q')}`})
    const q = `${url.searchParams.get('q')} from:${config.handle}`
    let search_url = new URL(`https://${url.host}/searchBlogs?q=${encodeURIComponent(q)}&limit=100&sort=latest&domain=${config.gate_host}`)
    await renderSearch(search_url)
  }

  async function renderSearch(search_url, ) {
    const response = await fetch(search_url.toString())
    const data = await response.json()
    let cursor = url.searchParams.get('cursor') ?? 0
    renderBlogPosts(data.posts, cursor)
    renderAvatar()
    renderJSONLD({
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": document.querySelector('title').innerText,
      "description": "符合搜索条件的文章列表",
      "itemListElement": data.posts.map(post => {
        const rkey = post.uri.split('/').pop()
        const external = post.record.embed.external
        const {title, description} = external
        const date = post.record.createdAt
        const author = post.author.displayName
        return {
          "@type": "ListItem",
          "item": {
            "@type": "Article",
            "mainEntityOfPage": `https://${config.blog_host}/${rkey}`,
            "headline": title,
            "datePublished": date,
            "dateModified": date,
            "author": [{
                "@type": "Person",
                "name": author,
                "url": `https://${config.blog_host}/about`
            }]
          }
        }
      })
    })
  }

  async function renderIndexPage(url) {
    let search_url = new URL(`https://${url.host}/searchBlogs?q=from%3A${config.handle}&limit=100&sort=latest&domain=${config.gate_host}`)
    const response = await fetch(search_url.toString())
    const data = await response.json()
    let cursor = url.searchParams.get('cursor') ?? 0
    renderBlogPosts(data.posts, cursor)
    renderAvatar()
    renderJSONLD({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": config.web_app_title,
      "url": `https://${config.blog_host}`,
      "potentialAction": {
        "@type": "SearchAction",
        "target": `https://${config.blog_host}/search?q={search_term}`,
        "query-input": "required name=search_term"
      }
    })
  }

  function renderBlogPosts(allPosts, cursor) {
    if (!allPosts.length) {
      document.querySelector('#postsContainer').innerHTML = '<div class="rich_media_area_primary">没有找到任何文章，<a href="/">回到主页</a></div>'
      document.querySelector('.navigator').style.display = 'none'
      return
    }

    const posts = allPosts.slice(cursor, cursor + config.search_page_size)
    let articleList = []
    for (let post of posts) {
      const external = post.record.embed.external
      let {title, description} = external
      title += post.no
      const date = post.record.createdAt
      let tags = post.record.facets.map(item => item.features[0]).filter(item => item.$type === 'app.bsky.richtext.facet#tag').map(item => item.tag)
      tags = tags.map(renderTagSegment).join('')
      const rkey = post.uri.split('/').pop()
      const author = post.author.displayName
      const ele = utils.convertStringToTemplate(articleTemplate, {title, date, author, description, tags, rkey})
      articleList.push(ele)
    }
    document.querySelector('#postsContainer').innerHTML = articleList.join('')

    if ((allPosts.length - 1) > (cursor + config.search_page_size)) {
      document.querySelector('#nextCursor').onclick = event => {
        renderBlogPosts(allPosts, cursor + config.search_page_size);
      }
      document.querySelector('#nextCursor').style.display = 'inline'
    } else {
      document.querySelector('#nextCursor').style.display = 'none'
    }

    if (cursor > 0) {
      document.querySelector('#preCursor').onclick = event => {
        renderBlogPosts(allPosts, Math.max(cursor - config.search_page_size, 0));
      }
      document.querySelector('#preCursor').style.display = 'inline'
    } else {
      document.querySelector('#preCursor').style.display = 'none'
    }
  }

  function renderJSONLD(data) {
    const script = document.createElement('script');
    script.setAttribute('type', 'application/ld+json');
    script.textContent = JSON.stringify(data);
    document.head.appendChild(script);
  }

  function renderAvatar() {
    document.querySelector('#actoravatar').style.background = `url(${config.avatar}) no-repeat`
    document.querySelector('#actoravatar').style.backgroundSize = 'cover'
    document.querySelector('#actorDisplayName').innerText = config.displayName
  }

  function renderTagSegment(tag) {
    return `<a class="meta_original_tag" href="/search?tag=${encodeURIComponent(tag)}">${tag}</a>`
  }

  const articleTemplate = `
<div class="rich_media_area_primary">
  <h2 class="rich_media_title">
  \${title}
  </h2>
  <div class="rich_media_meta_list">
  <em class="rich_media_meta rich_media_meta_text">
  \${date}
  </em>
  <em class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="/">
  \${author}
  </em>
  </div>
  <div class="markdown-body">
  \${description}
  </div>
  <div class="rich_media_tool">
  <div class="media_tool_meta tips_global meta_primary" style="">标签：</div>
  \${tags}
  <a class="media_tool_meta tips_global meta_extra" href="/\${rkey}" title="\${title}">
  阅读全文 »
  </a>
  </div>
</div>
  `
  </script>
</body>
</html>
