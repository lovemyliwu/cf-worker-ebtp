<!DOCTYPE html>
<html class='v2' dir='ltr' itemscope='' itemtype='http://schema.org/Blog' lang='zh-cn' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
<meta charset='utf-8'/>
<meta content='IE=edge' http-equiv='X-UA-Compatible'/>
<link href='/static/favicon.ico' rel='icon' type='image/x-icon'/>
<meta content='width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui' name='viewport'/>
<title>blog search page</title>
<meta content='yes' name='mobile-web-app-capable'/>
<meta content='yes' name='apple-mobile-web-app-capable'/>
<link href='/' rel='home'/>
<link href='/' rel='msapplication-starturl'/>
<link href='/static/img/avator.jpg' rel='icon'/>
<link href='/static/img/avator.jpg' rel='apple-touch-icon-precomposed'/>
<link href='/static/css/blog.css' rel='stylesheet'/>
</head>
<body class='rich_media rich_media_inner'>
  <div class='page-content footer-push section' id='container'>
    <div class='rich_media_tool navigator'>
      <div class='media_tool_meta tips_global meta_primary'>导航&#65306;</div>
      <a id="nexCursor" href="#">&#8592;较旧的博文</a>
      <a class='tips_global meta_extra' href='#'>&#8593;回到页顶</a>
    </div>
    <div class='footer-pad'></div>
  </div>
  <div class='qr_code_pc_outer'>
    <div class='qr_code_pc_inner'>
      <div class='qr_code_pc'>
      <div id="actorAvator" class='qr_code_pc_img'></div>
      <p id="actorDisplayName"></p>
      </div>
    </div>
  </div>
  <footer>Power by atproto & ebtp</footer>
  <script type="module">
  import * as utils from '/static/js/common.js'
  const response = await fetch('/config')
  const config = await response.json()
  let url = new URL(location.href)

  switch(url.pathname) {
    case '/':
      renderIndexPage(url)
      break
    case '/search':
      search(url)
      break
    default:
      throw Error(`path ${url.pathname} not support`)
  }
  await utils.initBackgroundPic();

  function search(url) {
    if (url.searchParams.get('q')) {
      console.log('keyword search')
    } else if (url.searchParams.get('tag')) {
      console.log('tag search')
    } else if (url.searchParams.get('since') && url.searchParams.get('until')) {
      console.log('archive search')
    }
  }

  async function renderIndexPage(url) {
    document.querySelector('title').innerText = config.web_app_title
    const response = await fetch(`/searchBlogs?q=from%3A${config.handle}&limit=${config.search_page_size}&sort=latest&domain=${config.gate_host}`)
    const data = await response.json()
    let articleList = []
    for (let post of data.posts) {
      const external = post.record.embed.external
      const {title, description} = external
      const date = post.record.createdAt
      let tags = post.record.facets.map(item => item.features[0]).filter(item => item.$type === 'app.bsky.richtext.facet#tag').map(item => item.tag)
      tags = tags.map(renderTagSegment).join('')
      const rkey = post.uri.split('/').pop()
      const author = post.author.displayName
      const ele = utils.convertStringToTemplate(articleTemplate, {title, date, author, description, tags, rkey})
      articleList.push(ele)
    }
    document.querySelector('#container').insertAdjacentHTML("afterbegin", articleList.join(''))

    if (data.cursor) {
      url.searchParams.set('cursor', data.cursor)
      document.querySelector('#nexCursor').setAttribute('href', url.toString())
    } else {
      document.querySelector('#nexCursor').style.display = 'none'
    }
  }

  function renderTagSegment(tag) {
    return `<a class="meta_original_tag" href="/search?tag=${encodeURIComponent(tag)}">${tag}</a>`
  }

  const articleTemplate = `
<div class="rich_media_area_primary">
  <h2 class="rich_media_title">
  \${title}
  </h2>
  <div class="rich_media_meta_list">
  <em class="rich_media_meta rich_media_meta_text">
  \${date}
  </em>
  <em class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="/">
  \${author}
  </em>
  </div>
  <div class="markdown-body">
  \${description}
  </div>
  <div class="rich_media_tool">
  <div class="media_tool_meta tips_global meta_primary" style="">标签：</div>
  \${tags}
  <a class="media_tool_meta tips_global meta_extra" href="/\${rkey}" title="\${title}">
  阅读全文 »
  </a>
  </div>
</div>
  `
  </script>
</body>
</html>
